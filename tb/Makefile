# =============================================================================
# QEDMMA Timestamp Capture - Cocotb Simulation Makefile
# Auto-generated by Radar Systems Architect v9.0
# Date: 2026-01-31
# =============================================================================

# Default simulator (options: verilator, icarus, questa)
SIM ?= verilator

# Language
TOPLEVEL_LANG = verilog

# Simulator-specific settings
ifeq ($(SIM), verilator)
    COMPILE_ARGS += -Wno-WIDTHEXPAND
    COMPILE_ARGS += -Wno-WIDTHTRUNC
    COMPILE_ARGS += -Wno-TIMESCALEMOD
    COMPILE_ARGS += --timing
    COMPILE_ARGS += --trace-fst
    COMPILE_ARGS += --trace-structs
    EXTRA_ARGS += --coverage
endif

ifeq ($(SIM), icarus)
    COMPILE_ARGS += -g2012
    COMPILE_ARGS += -DICARUS_VERILOG
endif

ifeq ($(SIM), questa)
    COMPILE_ARGS += +acc
    COMPILE_ARGS += -sv
endif

# Source files
VERILOG_SOURCES = \
    $(PWD)/../rtl/timestamp_capture_regs_pkg.sv \
    $(PWD)/../rtl/timestamp_capture.sv

# Top-level module
TOPLEVEL = timestamp_capture

# Python test module
MODULE = test_timestamp_capture

# Include cocotb makefiles
include $(shell cocotb-config --makefiles)/Makefile.sim

# =============================================================================
# Custom Targets
# =============================================================================

.PHONY: lint synth clean_all coverage

# Lint with Verilator
lint:
	@echo "Running Verilator lint..."
	verilator --lint-only -Wall \
		-Wno-WIDTHEXPAND -Wno-WIDTHTRUNC \
		--timing \
		$(VERILOG_SOURCES)
	@echo "Lint passed!"

# Run SVLint
svlint:
	@echo "Running SVLint..."
	svlint $(VERILOG_SOURCES)

# Coverage report
coverage:
	@echo "Generating coverage report..."
ifeq ($(SIM), verilator)
	verilator_coverage --annotate logs/coverage logs/coverage.dat
	@echo "Coverage report in logs/coverage/"
endif

# Quick smoke test (single test case)
smoke:
	$(MAKE) TESTCASE=test_reset_values

# Full regression
regression:
	$(MAKE) TESTCASE=test_reset_values
	$(MAKE) TESTCASE=test_version_id
	$(MAKE) TESTCASE=test_ctrl_register_rw
	$(MAKE) TESTCASE=test_pps_lock_detection
	$(MAKE) TESTCASE=test_timestamp_counter
	$(MAKE) TESTCASE=test_channel_capture
	$(MAKE) TESTCASE=test_multi_channel_capture
	$(MAKE) TESTCASE=test_fifo_overflow
	$(MAKE) TESTCASE=test_interrupt_generation
	$(MAKE) TESTCASE=test_sync_source_switching
	$(MAKE) TESTCASE=test_random_captures

# Clean all generated files
clean_all: clean
	rm -rf __pycache__
	rm -rf .pytest_cache
	rm -rf logs/
	rm -rf sim_build/
	rm -f *.vcd *.fst *.ghw

# Generate waveform viewer command
waves:
ifeq ($(SIM), verilator)
	@echo "View waveforms with: gtkwave dump.fst"
else
	@echo "View waveforms with: gtkwave dump.vcd"
endif

# Help target
help:
	@echo "QEDMMA Timestamp Capture Simulation"
	@echo "===================================="
	@echo ""
	@echo "Targets:"
	@echo "  make              - Run all tests with default simulator ($(SIM))"
	@echo "  make SIM=icarus   - Run with Icarus Verilog"
	@echo "  make SIM=verilator- Run with Verilator"
	@echo "  make lint         - Run Verilator lint"
	@echo "  make svlint       - Run SVLint"
	@echo "  make smoke        - Run quick smoke test"
	@echo "  make regression   - Run full regression"
	@echo "  make coverage     - Generate coverage report"
	@echo "  make waves        - Instructions for viewing waveforms"
	@echo "  make clean_all    - Clean all generated files"
	@echo ""
	@echo "Environment variables:"
	@echo "  SIM=verilator|icarus|questa"
	@echo "  TESTCASE=test_name"
	@echo "  WAVES=1 (enable waveform dump)"
