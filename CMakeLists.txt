# =============================================================================
# QEDMMA Timestamp Capture - CMake Build System
# Auto-generated by Radar Systems Architect v9.0 - DevOps Factory Lead
# Date: 2026-01-31
#
# Build:
#   mkdir build && cd build
#   cmake .. -DCMAKE_BUILD_TYPE=Release
#   make -j$(nproc)
#
# Cross-compile for Zynq:
#   cmake .. -DCMAKE_TOOLCHAIN_FILE=../cmake/zynq-toolchain.cmake
#
# Traceability:
#   [REQ-PIPE-001] Automated build pipeline for RTL
# =============================================================================

cmake_minimum_required(VERSION 3.16)

project(qedmma_timestamp_capture
    VERSION 1.0.0
    DESCRIPTION "QEDMMA Timestamp Capture Driver Library"
    LANGUAGES C CXX
)

# -----------------------------------------------------------------------------
# Options
# -----------------------------------------------------------------------------

option(BUILD_TESTS "Build unit tests" ON)
option(BUILD_EXAMPLES "Build example applications" ON)
option(BUILD_DOCS "Build documentation" OFF)
option(ENABLE_COVERAGE "Enable code coverage" OFF)
option(USE_SYSTEM_LIBIIO "Use system libiio instead of bundled" ON)

# -----------------------------------------------------------------------------
# Build Configuration
# -----------------------------------------------------------------------------

set(CMAKE_C_STANDARD 11)
set(CMAKE_C_STANDARD_REQUIRED ON)
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Default to Release if not specified
if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release CACHE STRING "Build type" FORCE)
endif()

# Compiler flags
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wall -Wextra -Wpedantic")
set(CMAKE_C_FLAGS_DEBUG "-g -O0 -DDEBUG")
set(CMAKE_C_FLAGS_RELEASE "-O3 -DNDEBUG")

if(ENABLE_COVERAGE)
    set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} --coverage")
    set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} --coverage")
endif()

# -----------------------------------------------------------------------------
# Dependencies
# -----------------------------------------------------------------------------

find_package(Threads REQUIRED)

if(USE_SYSTEM_LIBIIO)
    find_package(PkgConfig REQUIRED)
    pkg_check_modules(LIBIIO REQUIRED libiio)
endif()

# -----------------------------------------------------------------------------
# Library Target
# -----------------------------------------------------------------------------

add_library(timestamp_capture STATIC
    drivers/timestamp_capture_driver.c
)

target_include_directories(timestamp_capture
    PUBLIC
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/drivers>
        $<INSTALL_INTERFACE:include>
)

target_link_libraries(timestamp_capture
    PUBLIC
        Threads::Threads
)

if(USE_SYSTEM_LIBIIO)
    target_include_directories(timestamp_capture PUBLIC ${LIBIIO_INCLUDE_DIRS})
    target_link_libraries(timestamp_capture PUBLIC ${LIBIIO_LIBRARIES})
endif()

# Generate version header
configure_file(
    ${CMAKE_CURRENT_SOURCE_DIR}/cmake/version.h.in
    ${CMAKE_CURRENT_BINARY_DIR}/include/timestamp_capture_version.h
    @ONLY
)

target_include_directories(timestamp_capture
    PUBLIC
        $<BUILD_INTERFACE:${CMAKE_CURRENT_BINARY_DIR}/include>
)

# -----------------------------------------------------------------------------
# Tests
# -----------------------------------------------------------------------------

if(BUILD_TESTS)
    enable_testing()
    
    # Unit test executable
    add_executable(test_timestamp_capture
        tests/test_timestamp_capture.c
    )
    
    target_link_libraries(test_timestamp_capture
        PRIVATE
            timestamp_capture
    )
    
    add_test(NAME unit_tests COMMAND test_timestamp_capture)
endif()

# -----------------------------------------------------------------------------
# Examples
# -----------------------------------------------------------------------------

if(BUILD_EXAMPLES)
    # Basic capture example
    add_executable(example_capture
        examples/basic_capture.c
    )
    
    target_link_libraries(example_capture
        PRIVATE
            timestamp_capture
    )
    
    # Multi-channel example
    add_executable(example_multichannel
        examples/multichannel_capture.c
    )
    
    target_link_libraries(example_multichannel
        PRIVATE
            timestamp_capture
    )
endif()

# -----------------------------------------------------------------------------
# Installation
# -----------------------------------------------------------------------------

include(GNUInstallDirs)

install(TARGETS timestamp_capture
    EXPORT TimestampCaptureTargets
    LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
    ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
    RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
)

install(FILES
    drivers/timestamp_capture_regs.h
    ${CMAKE_CURRENT_BINARY_DIR}/include/timestamp_capture_version.h
    DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
)

install(EXPORT TimestampCaptureTargets
    FILE TimestampCaptureTargets.cmake
    NAMESPACE QEDMMA::
    DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/TimestampCapture
)

# -----------------------------------------------------------------------------
# CPack Configuration
# -----------------------------------------------------------------------------

set(CPACK_PACKAGE_NAME "qedmma-timestamp-capture")
set(CPACK_PACKAGE_VERSION_MAJOR ${PROJECT_VERSION_MAJOR})
set(CPACK_PACKAGE_VERSION_MINOR ${PROJECT_VERSION_MINOR})
set(CPACK_PACKAGE_VERSION_PATCH ${PROJECT_VERSION_PATCH})
set(CPACK_PACKAGE_DESCRIPTION_SUMMARY ${PROJECT_DESCRIPTION})
set(CPACK_PACKAGE_VENDOR "QEDMMA Project")
set(CPACK_GENERATOR "DEB;RPM;TGZ")

include(CPack)

# -----------------------------------------------------------------------------
# Summary
# -----------------------------------------------------------------------------

message(STATUS "")
message(STATUS "=== QEDMMA Timestamp Capture Configuration ===")
message(STATUS "Version:          ${PROJECT_VERSION}")
message(STATUS "Build type:       ${CMAKE_BUILD_TYPE}")
message(STATUS "Build tests:      ${BUILD_TESTS}")
message(STATUS "Build examples:   ${BUILD_EXAMPLES}")
message(STATUS "Code coverage:    ${ENABLE_COVERAGE}")
message(STATUS "System libiio:    ${USE_SYSTEM_LIBIIO}")
message(STATUS "Install prefix:   ${CMAKE_INSTALL_PREFIX}")
message(STATUS "================================================")
message(STATUS "")
